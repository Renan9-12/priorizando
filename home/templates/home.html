<h1> Home page</h1>ml" %}
{% block content %}
{% if user.is_authenticated %}
  <section class="row">
    <input id="title" placeholder="Nova tarefa..." />
    <input id="desc" placeholder="Descrição (opcional)" />
    <button id="addBtn">Adicionar</button>
  </section>

  <section id="list"></section>

  <script>
    // CSRF
    function getCookie(name){
      const v=`; ${document.cookie}`.split(`; ${name}=`); if(v.length===2) return v.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    async function fetchTasks(){
      const res = await fetch("/api/tasks/", {headers:{"Accept":"application/json"}});
      const data = await res.json();
      render(data);
    }

    function render(tasks){
      const root = document.getElementById("list");
      root.innerHTML = "";
      tasks.forEach(t=>{
        const el = document.createElement("div");
        el.className = "task" + (t.is_completed ? " done" : "");
        el.innerHTML = `
          <div>
            <strong>${t.title}</strong><br>
            <small>${t.description||""}</small>
          </div>
          <div class="row">
            ${t.is_completed ? "" : `<button data-id="${t.id}" class="doneBtn">Concluir</button>`}
            <button data-id="${t.id}" class="delBtn">Excluir</button>
          </div>
        `;
        root.appendChild(el);
      });

      document.querySelectorAll(".doneBtn").forEach(b=>{
        b.onclick = async () => {
          await fetch(`/api/tasks/${b.dataset.id}/complete/`, {
            method:"POST",
            headers:{"X-CSRFToken":csrftoken,"Accept":"application/json"}
          });
          fetchTasks();
        }
      });
      document.querySelectorAll(".delBtn").forEach(b=>{
        b.onclick = async () => {
          await fetch(`/api/tasks/${b.dataset.id}/`, {
            method:"DELETE",
            headers:{"X-CSRFToken":csrftoken}
          });
          fetchTasks();
        }
      });
    }

    document.getElementById("addBtn").onclick = async () => {
      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("desc").value.trim();
      if(!title) return alert("Título é obrigatório");
      await fetch("/api/tasks/", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "X-CSRFToken":csrftoken,
          "Accept":"application/json"
        },
        body: JSON.stringify({title, description})
      });
      document.getElementById("title").value="";
      document.getElementById("desc").value="";
      fetchTasks();
    };

    fetchTasks();
  </script>
{% else %}
  <p>Faça <a href="/login/">login</a> para gerenciar suas tarefas.</p>
{% endif %}
{% endblock %}